<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Notes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f4f5;
            --text-color: #18181b;
            --editor-bg: #ffffff;
            --border-color: #e4e4e7;
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
        }

        [data-theme="dark"] {
            --bg-color: #18181b;
            --text-color: #f4f4f5;
            --editor-bg: #27272a;
            --border-color: #3f3f46;
            --accent: #60a5fa;
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; height: 100vh; display: flex; flex-direction: column; }
        
        header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--editor-bg); }
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        main { flex: 1; display: flex; overflow: hidden; }
        .pane { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: auto; }
        .pane.editor { border-right: 1px solid var(--border-color); }
        
        textarea { width: 100%; height: 100%; border: none; resize: none; outline: none; background: transparent; color: var(--text-color); font-size: 1rem; font-family: 'Courier New', monospace; }
        
        #preview img { max-width: 100%; }
        #preview blockquote { border-left: 4px solid var(--accent); margin-left: 0; padding-left: 1rem; color: #71717a; }

        button { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); cursor: pointer; border-radius: 4px; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--border-color); }
        button.active { background: var(--accent); color: white; border-color: var(--accent); }
        button.disconnect { background: var(--danger); color: white; border-color: var(--danger); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--editor-bg); padding: 2rem; border-radius: 8px; max-width: 400px; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        input[type="password"] { width: 100%; padding: 0.5rem; margin: 1rem 0; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 4px; box-sizing: border-box; }
        
        .stats { font-size: 0.8rem; color: #71717a; margin-top: auto; padding: 0.5rem 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; background: var(--editor-bg); }
        
        #qrcode { margin-top: 1rem; display: flex; justify-content: center; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
        .badge.secure { background: var(--success); color: white; }
        .badge.live { background: var(--danger); color: white; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media (max-width: 768px) {
            main { flex-direction: column; }
            .pane.editor { border-right: none; border-bottom: 1px solid var(--border-color); height: 50%; }
            .toolbar button span { display: none; }
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; display: flex; align-items: center;">
        Silent Notes
        <span id="securityBadge" class="badge secure" style="display:none">SECURE</span>
        <span id="liveBadge" class="badge live" style="display:none">‚óè LIVE</span>
    </div>
    <div class="toolbar">
        <button onclick="toggleTheme()" title="Theme">üåì</button>
        <button onclick="handleLiveClick()" id="btnLive" title="Realtime P2P">üì° <span>P2P</span></button>
        <button onclick="showPasswordModal()" id="btnLock" title="Password Protection">üîí</button>
        <button onclick="showQR()" title="QR Code">üì± <span>QR</span></button>
        <button onclick="copyLink()" title="Copy Link">üîó</button>
    </div>
</header>

<main>
    <div class="pane editor">
        <textarea id="editor" placeholder="Type here... (Markdown supported)"></textarea>
    </div>
    <div class="pane preview">
        <div id="preview"></div>
    </div>
</main>

<div class="stats">
    <span id="charCount">0 chars</span>
    <span id="urlUsage">URL: 0%</span>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h3>üîê Set Password</h3>
        <p>Encrypt this note before sharing.</p>
        <input type="password" id="passwordInput" placeholder="New Password">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closeModal()">Cancel</button>
            <button onclick="applyPassword()" class="active">Protect</button>
        </div>
    </div>
</div>

<div id="decryptModal" class="modal">
    <div class="modal-content">
        <h3>üîì Encrypted Note</h3>
        <p>Enter password to view content.</p>
        <input type="password" id="decryptInput" placeholder="Password">
        <button onclick="attemptDecrypt()" class="active" style="width: 100%">Unlock</button>
        <div id="decryptError" style="color: var(--danger); margin-top: 10px; font-size: 0.9rem; display: none;">Invalid Password</div>
    </div>
</div>

<div id="qrModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
    <div class="modal-content" style="text-align: center;">
        <h3>Scan to Share</h3>
        <div id="qrcode"></div>
    </div>
</div>

<script>
    // --- Global State ---
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const MAX_URL_LENGTH = 2000;
    
    let currentPassword = null;
    let encryptedPayloadCache = null; // Stores encrypted data while waiting for password
    
    // P2P State
    let peer = null;
    let conn = null;
    let isHost = false; 
    let isGuest = false; 
    let ignoreChange = false; // Prevents infinite loop during programmatic updates

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', () => {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleTheme();
        checkHash(); 
    });

    // Handle back/forward buttons
    window.addEventListener('hashchange', checkHash);

    function checkHash() {
        if (ignoreChange) return;

        const hash = window.location.hash.substring(1);
        if (!hash) return;

        const [key, val] = hash.split('=');

        if (key === 'peer') {
            // User opened a P2P link (Guest mode)
            if (!isGuest && !isHost) initPeerGuest(val);
        } else if (key === 'enc') {
            // Encrypted content found in URL
            encryptedPayloadCache = val;
            currentPassword = null; 
            showDecryptModal();
        } else if (key === 'lz') {
            // Standard compressed content
            const decompressed = LZString.decompressFromEncodedURIComponent(val);
            if (decompressed !== null) {
                editor.value = decompressed;
                updatePreview();
            }
        }
    }

    // --- Editor & Core Logic ---
    editor.addEventListener('input', () => {
        if (ignoreChange) return;
        updatePreview();
        updateURLAndBroadcast();
    });

    function updatePreview() {
        preview.innerHTML = marked.parse(editor.value);
        updateStats();
    }

    // Generates the data blob (Compressed or Encrypted+Compressed)
    function generatePayload() {
        const text = editor.value;
        if (!text) return { mode: 'raw', data: '' };

        if (currentPassword) {
            // Encrypt -> Sign (HMAC) -> Stringify -> Compress
            const encrypted = CryptoJS.AES.encrypt(text, currentPassword).toString();
            const signature = CryptoJS.HmacSHA256(encrypted, currentPassword).toString();
            const packed = JSON.stringify({ ct: encrypted, sig: signature });
            return { mode: 'enc', data: LZString.compressToEncodedURIComponent(packed) };
        } else {
            // Compress only
            return { mode: 'lz', data: LZString.compressToEncodedURIComponent(text) };
        }
    }

    function updateURLAndBroadcast() {
        const payload = generatePayload();
        
        // Update URL history only if NOT a guest
        // Guests keep the #peer=ID hash to maintain connection context
        if (!isGuest) {
            const hash = payload.data ? `#${payload.mode}=${payload.data}` : ' ';
            history.replaceState(null, null, hash);
        }

        updateSecurityUI(payload.mode === 'enc');

        // Broadcast to P2P peer if connected
        if (conn && conn.open) {
            conn.send({ type: 'update', mode: payload.mode, data: payload.data });
        }
    }

    function updateSecurityUI(isSecure) {
        const badge = document.getElementById('securityBadge');
        const btn = document.getElementById('btnLock');
        
        if (isSecure) {
            badge.style.display = 'inline-block';
            btn.classList.add('active');
        } else {
            badge.style.display = 'none';
            btn.classList.remove('active');
        }
    }

    // --- Password Management ---
    function showPasswordModal() {
        document.getElementById('passwordModal').style.display = 'flex';
        document.getElementById('passwordInput').focus();
    }

    function showDecryptModal() {
        document.getElementById('decryptModal').style.display = 'flex';
        document.getElementById('decryptError').style.display = 'none';
        document.getElementById('decryptInput').focus();
    }

    function closeModal() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    function applyPassword() {
        const pwd = document.getElementById('passwordInput').value;
        if (pwd) {
            currentPassword = pwd;
            closeModal();
            updateURLAndBroadcast();
            alert("Note protected.");
        }
    }

    function attemptDecrypt() {
        const pwd = document.getElementById('decryptInput').value;
        const payload = encryptedPayloadCache;
        
        try {
            const jsonStr = LZString.decompressFromEncodedURIComponent(payload);
            const data = JSON.parse(jsonStr);
            
            // Verify HMAC signature
            const calcedSig = CryptoJS.HmacSHA256(data.ct, pwd).toString();
            if (calcedSig !== data.sig) throw new Error("Invalid Signature");

            // Decrypt
            const bytes = CryptoJS.AES.decrypt(data.ct, pwd);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            
            if (!originalText) throw new Error("Decrypt Failed");

            // Success
            ignoreChange = true; 
            editor.value = originalText;
            currentPassword = pwd; // Cache password for session
            ignoreChange = false;

            updatePreview();
            updateSecurityUI(true);
            closeModal();
            
        } catch (e) {
            console.error(e);
            document.getElementById('decryptError').style.display = 'block';
        }
    }

    // --- P2P / WebRTC Logic ---
    
    function handleLiveClick() {
        if (isGuest || isHost) {
            disconnectP2P();
        } else {
            startPeerHost();
        }
    }

    function startPeerHost() {
        peer = new Peer(); // Generates random ID
        
        peer.on('open', (id) => {
            isHost = true;
            
            // Update UI
            const btn = document.getElementById('btnLive');
            btn.classList.add('active');
            btn.querySelector('span').innerText = "Stop Live";
            document.getElementById('liveBadge').style.display = 'inline-block';
            
            // Generate Share Link
            const liveUrl = `${window.location.origin}${window.location.pathname}#peer=${id}`;
            
            navigator.clipboard.writeText(liveUrl).then(() => {
                alert("LIVE Session Started!\nLink copied to clipboard.");
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });
        });
    }

    function initPeerGuest(hostId) {
        editor.setAttribute('readonly', true);
        editor.value = "Connecting to host...";
        
        peer = new Peer();
        peer.on('open', () => {
            isGuest = true;
            conn = peer.connect(hostId);
            
            // Update UI
            const btn = document.getElementById('btnLive');
            btn.classList.add('disconnect');
            btn.querySelector('span').innerText = "Disconnect";
            
            handleConnection(conn);
        });

        peer.on('error', (err) => {
            alert("P2P Error: " + err);
            editor.value = "Connection failed.";
        });
    }

    function handleConnection(connection) {
        conn = connection;

        conn.on('open', () => {
            document.getElementById('liveBadge').style.display = 'inline-block';
            document.getElementById('liveBadge').innerText = isHost ? "‚óè HOST" : "‚óè GUEST";
            
            // Host sends current state immediately upon connection
            if (isHost) updateURLAndBroadcast();
            
            // Guest can now edit (bi-directional sync)
            if (isGuest) editor.removeAttribute('readonly');
        });

        conn.on('data', (data) => {
            if (data.type === 'update') processIncomingData(data);
        });

        conn.on('close', () => {
            alert("P2P Connection closed.");
            disconnectP2P();
        });
    }

    function processIncomingData(data) {
        if (data.mode === 'enc') {
            // Received Encrypted Data
            encryptedPayloadCache = data.data;
            updateSecurityUI(true);

            // Try automatic decryption if we already have a password
            if (currentPassword) {
                try {
                    const jsonStr = LZString.decompressFromEncodedURIComponent(data.data);
                    const pkg = JSON.parse(jsonStr);
                    const sig = CryptoJS.HmacSHA256(pkg.ct, currentPassword).toString();
                    
                    if (sig === pkg.sig) {
                        const bytes = CryptoJS.AES.decrypt(pkg.ct, currentPassword);
                        const txt = bytes.toString(CryptoJS.enc.Utf8);
                        
                        ignoreChange = true;
                        editor.value = txt;
                        updatePreview();
                        ignoreChange = false;
                        return; 
                    }
                } catch(e) {}
            }
            
            // If automatic decryption fails, prompt user
            if(document.getElementById('decryptModal').style.display === 'none') {
                showDecryptModal(); 
            }
        
        } else if (data.mode === 'lz') {
            // Received Clear Data
            const txt = LZString.decompressFromEncodedURIComponent(data.data);
            
            ignoreChange = true;
            editor.value = txt;
            updatePreview();
            updateSecurityUI(false);
            currentPassword = null; // Reset password if host removed it
            closeModal();
            ignoreChange = false;
        }
    }

    function disconnectP2P() {
        if (conn) conn.close();
        if (peer) peer.destroy();
        
        peer = null;
        conn = null;
        isHost = false;
        isGuest = false;
        
        // Reset UI
        const btn = document.getElementById('btnLive');
        btn.classList.remove('active', 'disconnect');
        btn.querySelector('span').innerText = "P2P";
        document.getElementById('liveBadge').style.display = 'none';
        
        // Clean URL
        updateURLAndBroadcast();
        editor.removeAttribute('readonly');
    }

    // --- Utilities ---
    function updateStats() {
        const text = editor.value;
        document.getElementById('charCount').innerText = `${text.length} chars`;
        
        const urlLen = window.location.href.length;
        const p = Math.min(100, Math.round((urlLen / MAX_URL_LENGTH) * 100));
        const uEl = document.getElementById('urlUsage');
        uEl.innerText = `URL: ${p}%`;
        uEl.style.color = urlLen > MAX_URL_LENGTH ? 'var(--danger)' : 'inherit';
    }

    function toggleTheme() {
        const b = document.body;
        b.getAttribute('data-theme') === 'dark' ? b.removeAttribute('data-theme') : b.setAttribute('data-theme', 'dark');
    }

    function showQR() {
        document.getElementById('qrModal').style.display = 'flex';
        const c = document.getElementById('qrcode');
        c.innerHTML = '';
        new QRCode(c, { text: window.location.href, width: 200, height: 200 });
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => alert("Link copied!"));
    }
</script>

</body>
</html>
